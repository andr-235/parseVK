# План реализации фичи «На карандаше»

## Цели
- Добавить пользовательский список авторов «На карандаше» с карточками и детальным просмотром.
- Обеспечить автоматический мониторинг всех новых комментариев автора, независимо от постов, обработанных парсером.
- Вынести настройку «Отслеживать все комментарии» в общую конфигурацию, чтобы она использовалась и фронтендом, и фоновой джобой.

## 1. Данные и Prisma
- Создать таблицу `WatchlistAuthor` с полями: ссылка на `Author`, ссылка на исходный `Comment`, статусы мониторинга, `lastCheckedAt`, `lastActivityAt`, счётчик найденных комментариев и ссылку на настройки.
- Создать таблицу `WatchlistSettings` с полями: `trackAllComments` (boolean), период опроса, лимиты по количеству проверяемых авторов. Настройки привязать к пользователю или сделать глобальными (начать с глобальной записи, id=1).
- Обновить `Comment` и связанные сервисы так, чтобы комментарии, найденные фоновой джобой по авторам, сохранялись аналогично парсеру задач (с указанием источника).
- Добавить Prisma миграции и сгенерировать клиент.

## 2. Бэкенд API
- Создать модуль `WatchlistModule` c контроллером, сервисом и DTO.
- Методы API:
  - `POST /watchlist/authors` — добавляет автора по `commentId` или `authorVkId`, создаёт `WatchlistAuthor` и включает мониторинг.
  - `GET /watchlist/authors` — список карточек с агрегатами (количество комментариев, статус, дата последней активности).
  - `GET /watchlist/authors/:id` — детальная информация: профиль автора, список всех его комментариев (с пагинацией), история проверок.
  - `PATCH /watchlist/authors/:id` — обновление статуса или ручное снятие с мониторинга.
  - `GET /watchlist/settings` и `PATCH /watchlist/settings` — работа с `WatchlistSettings`, включая переключатель «Отслеживать все комментарии».
- Вынести общую логику сохранения авторов и комментариев из `ParsingTaskRunner` в сервис, переиспользуемый джобой и существующими задачами.
- Покрыть новые маршруты unit/e2e тестами.

## 3. Фоновый мониторинг
- Подключить `@nestjs/schedule` или существующую очередь заданий для периодического обновления авторов.
- Для каждого активного `WatchlistAuthor` брать последнюю известную активность и через `VkService` собирать **все** новые комментарии автора, а не только по ранее спарсенным постам (использовать `newsfeed.search`, `wall.getComments` по последним постам автора и групп, `execute` для батчей).
- Обновлять `lastCheckedAt`, `lastActivityAt`, статус и сохранять новые комментарии через общий сервис.
- Логировать ошибки, учитывать лимиты VK API и настройки интервалов из `WatchlistSettings`.

## 4. Фронтенд — API и сторы
- Добавить `watchlistApi` с методами для авторов и настроек.
- Создать `useWatchlistStore` в `front/src/stores` для работы со списком авторов, выбранным автором, состояниями загрузки и настройками мониторинга.
- Добавить обработку переключателя «Отслеживать все комментарии» — запросить настройки при загрузке страницы и позволить изменять значение.
- Обновить типы и утилиты, чтобы карточки авторов отображали текущий статус и счётчики.

## 5. Фронтенд — UI и маршруты
- Добавить страницу `WatchlistPage` с таблицей/сеткой карточек, фильтрами и кнопкой перехода к деталям автора.
- В `CommentCard` добавить кнопку «На карандаше» с состоянием disabled, если автор уже в списке.
- В детальной панели автора вывести все найденные комментарии (заказ по дате), статус мониторинга и настройку «Отслеживать все комментарии» (только для чтения, редактирование — на общей странице настроек).
- Добавить пункт меню и маршрут `/watchlist` в `App.tsx` и `Sidebar.tsx`.

## 6. Тестирование и документация
- API: unit-тесты для сервиса мониторинга, e2e-тесты для эндпоинтов авторов и настроек.
- Фронтенд: тесты стора (mock fetch), компонентные тесты карточек и страницы, проверка маршрутизации.
- Обновить README/DEPLOYMENT.md с описанием мониторинга авторов, настройками `WatchlistSettings.trackAllComments` и лимитами VK API.

## 7. Открытые вопросы
- Нужно согласовать источники VK API для получения всех комментариев пользователя (ограничения методов, необходимость токена с расширенными правами).
- Требуется ли отправлять уведомления при обнаружении новой активности и где их отображать.
- Нужно ли логировать историю проверок (`WatchlistCheckLog`) для аудита и отладки.

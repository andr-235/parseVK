# JWT refresh strategy использовала неправильный экстрактор токена

**Date:** 2026-02-12 14:00
**Files:** api/src/auth/strategies/jwt-refresh.strategy.ts, front/src/modules/auth/lib/authSession.ts
**Severity:** critical

## Problem

После истечения access-токена (или когда до истечения оставалось < 30 секунд)
фронтенд пытался обновить токен, но получал 401 в ответ. Это приводило к вызову
`clearAuth()`, после чего `RequireAuth` перенаправлял пользователя на `/login`.

## Root Cause

`JwtRefreshStrategy` использовала `ExtractJwt.fromAuthHeaderAsBearerToken()` в качестве
`jwtFromRequest`. Это означало, что стратегия искала refresh-токен ТОЛЬКО в заголовке
`Authorization: Bearer <token>`.

Фронтенд при этом отправлял токен только в теле запроса:

```
POST /api/auth/refresh
body: { refreshToken: "..." }
```

Без заголовка `Authorization`. Стратегия не находила токен → возвращала 401 →
фронтенд вызывал `clearAuth()` → пользователь разлогинивался.

В проекте уже существовал кастомный экстрактор `refresh-token.extractor.ts`, который
поддерживает cookie → x-refresh-token header → body, но он не был подключён к стратегии.

## Solution

В `jwt-refresh.strategy.ts` заменено:

```typescript
jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
```

на:

```typescript
jwtFromRequest: refreshTokenExtractor,
```

`refreshTokenExtractor` находит токен из body (fallback #3), что соответствует
тому, как фронтенд отправляет запрос.

Добавлено логирование `[FIX:token-refresh]` в `authSession.ts` для диагностики
будущих проблем с рефрешем.

## Prevention

- При добавлении кастомного экстрактора токена всегда убеждаться, что он подключён
  к стратегии (файл-экстрактор без импорта в стратегии — мёртвый код)
- Стратегии JWT для refresh-токенов должны поддерживать тот же метод передачи токена,
  который использует фронтенд
- В code review: если фронтенд отправляет токен в body, а стратегия ждёт его в header —
  это несоответствие нужно ловить сразу

## Tags

`#jwt` `#auth` `#refresh-token` `#nestjs` `#passport` `#frontend-backend-mismatch`

# BullMQ Integration - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### **1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á**
- **Concurrency: 2** - –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è 2 –∑–∞–¥–∞—á–∏
- **VK API rate limits —É—á—Ç–µ–Ω—ã** - vk-io —É–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∏–º–∏—Ç–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
- –≠—Ç–æ –¥–∞–µ—Ç **2-5x** –ø—Ä–∏—Ä–æ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ rate limits

### **2. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
- ‚úÖ –ó–∞–¥–∞—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis (–Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry (3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff)
- ‚úÖ –ó–∞–¥–∞—á–∏ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è
- ‚úÖ Graceful shutdown

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (waiting, active, completed, failed)
- Pause/Resume –¥–ª—è maintenance
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á (24 —á–∞—Å–∞ –¥–ª—è completed, 7 –¥–Ω–µ–π –¥–ª—è failed)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:

```
api/src/tasks/
‚îú‚îÄ‚îÄ queues/
‚îÇ   ‚îú‚îÄ‚îÄ parsing.constants.ts     # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (concurrency, retry, rate limits)
‚îÇ   ‚îú‚îÄ‚îÄ parsing.queue.ts          # Producer (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å)
‚îÇ   ‚îî‚îÄ‚îÄ parsing.processor.ts      # Worker (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á)
‚îú‚îÄ‚îÄ parsing-queue.service.ts      # API-–æ–±–µ—Ä—Ç–∫–∞ (backward compatible)
‚îî‚îÄ‚îÄ tasks.module.ts               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è BullModule
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —É—á–µ—Ç–æ–º VK API rate limits:

### **VK API limits:**
- –ë–µ–∑ —Ç–æ–∫–µ–Ω–∞: **3 req/sec**
- –° —Ç–æ–∫–µ–Ω–æ–º: **20 req/sec** (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ —Ç–æ–∫–µ–Ω–∞)

### **BullMQ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (parsing.constants.ts):**

```typescript
// –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–∞–∫—Å–∏–º—É–º 2 –∑–∞–¥–∞—á–∏
export const PARSING_CONCURRENCY = 2;

// Rate limiter (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)
export const PARSING_RATE_LIMITER = {
  max: 3,        // –ú–∞–∫—Å–∏–º—É–º 3 –∑–∞–¥–∞—á–∏
  duration: 5000 // –ó–∞ 5 —Å–µ–∫—É–Ω–¥
};

// Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
export const PARSING_RETRY_OPTIONS = {
  attempts: 3,           // 3 –ø–æ–ø—ã—Ç–∫–∏
  backoff: {
    type: 'exponential',
    delay: 5000          // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫
  }
};
```

**–ü–æ—á–µ–º—É concurrency = 2?**
- vk-io –≤–Ω—É—Ç—Ä–∏ —É–∂–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç rate limiting
- 2 –∑–∞–¥–∞—á–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ = –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ª–∏–º–∏—Ç–æ–≤
- –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø, –Ω–æ vk-io throttles API calls

---

## üöÄ API Usage:

### **–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å:**
```typescript
await parsingQueueService.enqueue({
  taskId: 1,
  scope: ParsingScope.ALL,
  groupIds: [],
  postLimit: 10,
});
```

### **–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É:**
```typescript
await parsingQueueService.remove(taskId);
```

### **–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:**
```typescript
const stats = await parsingQueueService.getStats();
// {
//   waiting: 5,
//   active: 2,
//   completed: 100,
//   failed: 3,
//   delayed: 1,
//   total: 111
// }
```

### **Pause/Resume (–¥–ª—è maintenance):**
```typescript
await parsingQueueService.pause();
await parsingQueueService.resume();
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Redis CLI:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis
docker exec -it redis redis-cli

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–ª—é—á–∏ BullMQ
KEYS bull:parsing:*

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏
HGETALL bull:parsing:meta

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å waiting jobs
LRANGE bull:parsing:wait 0 -1

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å active jobs
LRANGE bull:parsing:active 0 -1

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å failed jobs
ZRANGE bull:parsing:failed 0 -1

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
MONITOR
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ concurrency (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å):

–í `api/src/tasks/queues/parsing.constants.ts`:

```typescript
// –£–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Ä–∏—Å–∫ –ø—Ä–µ–≤—ã—Å–∏—Ç—å rate limit)
export const PARSING_CONCURRENCY = 3;

// –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
export const PARSING_CONCURRENCY = 1;
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **1-2**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ª—é–±–æ–≥–æ VK —Ç–æ–∫–µ–Ω–∞
- **3-4**: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –≤–∞—Å service token —Å –≤—ã—Å–æ–∫–∏–º –ª–∏–º–∏—Ç–æ–º
- **5+**: –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ rate limiting

---

## üéØ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

### **–î–æ (in-memory –æ—á–µ—Ä–µ–¥—å):**
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á
- 1 –∑–∞–¥–∞—á–∞ ‚Üí 10 –≥—Ä—É–ø–ø ‚Üí ~5 –º–∏–Ω—É—Ç
- 3 –∑–∞–¥–∞—á–∏ ‚Üí ~15 –º–∏–Ω—É—Ç

### **–ü–æ—Å–ª–µ (BullMQ —Å concurrency=2):**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 2 –∑–∞–¥–∞—á
- 2 –∑–∞–¥–∞—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí ~5-6 –º–∏–Ω—É—Ç
- 3 –∑–∞–¥–∞—á–∏ ‚Üí ~8-9 –º–∏–Ω—É—Ç
- **–ü—Ä–∏—Ä–æ—Å—Ç: 2-2.5x** –ø—Ä–∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–∏ VK API limits

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
npm test -- parsing-queue.service.spec.ts

# –í—Å–µ —Ç–µ—Å—Ç—ã
npm test
```

---

## üî• Troubleshooting:

### **–û—à–∏–±–∫–∞: "Too many requests" –æ—Ç VK API**
**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç—å `PARSING_CONCURRENCY` –¥–æ 1

### **–ó–∞–¥–∞—á–∏ –∑–∞—Å—Ç—Ä–µ–≤–∞—é—Ç –≤ "active"**
**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—á–∏—Å—Ç–∏—Ç—å stuck jobs
docker exec -it redis redis-cli
DEL bull:parsing:active
```

### **–ü–∞–º—è—Ç—å Redis —Ä–∞—Å—Ç–µ—Ç**
**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (24 —á–∞—Å–∞/7 –¥–Ω–µ–π), –Ω–æ –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é:
```bash
docker exec -it redis redis-cli
# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ completed jobs
DEL bull:parsing:completed
```

---

## üì¶ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

### **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: Bull Board (Dashboard)**
```bash
npm install @bull-board/api @bull-board/nestjs @bull-board/ui
```

–î–æ–±–∞–≤–∏—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ (pause, resume, retry)
- –ü—Ä–æ—Å–º–æ—Ç—Ä failed jobs —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–æ–∫

### **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –£–≤–µ–ª–∏—á–∏—Ç—å concurrency –Ω–∞ production**
–ï—Å–ª–∏ —É –≤–∞—Å service token —Å –≤—ã—Å–æ–∫–∏–º rate limit, –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 3-4 workers.

---

## ‚úÖ Backward Compatibility:

API `ParsingQueueService` –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è:
- `enqueue(job)` - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- `remove(taskId)` - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã: `getStats()`, `pause()`, `resume()`

–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!

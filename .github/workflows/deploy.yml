name: Deploy to Production Server

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Debian Server
    runs-on: [self-hosted]
    timeout-minutes: 90
    permissions:
      contents: read
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    env:
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
      COMPOSE_FILE: docker-compose.deploy.yml

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Update code
        working-directory: /opt/parseVK
        timeout-minutes: 5
        run: |
          echo "=== Updating code ==="

          if ! git remote get-url origin > /dev/null 2>&1; then
            echo "Error: Git remote 'origin' is not configured"
            exit 1
          fi

          if ! git fetch origin; then
            echo "Error: Failed to fetch from origin"
            exit 1
          fi

          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
          echo "Current branch: $CURRENT_BRANCH"

          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "Switching to main branch..."
            git checkout -f main 2>/dev/null || git checkout -b main origin/main
          fi

          if ! git reset --hard origin/main; then
            echo "Error: Failed to reset to origin/main"
            exit 1
          fi

          echo "Updated to commit: $(git rev-parse HEAD)"

      - name: Check for migrations
        id: check_migrations
        working-directory: /opt/parseVK
        run: |
          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          CURRENT_COMMIT=$(git rev-parse HEAD)

          if [ -z "$PREV_COMMIT" ] || ! git cat-file -e "${PREV_COMMIT}^{commit}" 2>/dev/null; then
            echo "needs_migrations=true" >> $GITHUB_OUTPUT
            echo "No previous commit found, will run migrations"
          else
            CHANGED_FILES=$(git diff --name-only "$PREV_COMMIT" "$CURRENT_COMMIT" || true)
            if echo "$CHANGED_FILES" | grep -qE '^api/|^prisma/'; then
              echo "needs_migrations=true" >> $GITHUB_OUTPUT
              echo "API or Prisma files changed, migrations needed"
            else
              echo "needs_migrations=false" >> $GITHUB_OUTPUT
              echo "No API or Prisma changes, skipping migrations"
            fi
          fi

      - name: Start database and dependencies
        working-directory: /opt/parseVK
        timeout-minutes: 5
        if: steps.check_migrations.outputs.needs_migrations == 'true'
        run: |
          echo "=== Starting database and dependencies ==="

          docker compose -f "$COMPOSE_FILE" up -d db redis

          echo "=== Waiting for database to be ready ==="
          MAX_WAIT=60
          WAIT_COUNT=0
          while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
            if docker compose -f "$COMPOSE_FILE" exec -T db pg_isready -U postgres -d vk_api > /dev/null 2>&1; then
              echo "Database is ready"
              break
            fi
            echo "Waiting for database... ($WAIT_COUNT/$MAX_WAIT)"
            sleep 1
            WAIT_COUNT=$((WAIT_COUNT + 1))
          done

          if [ $WAIT_COUNT -eq $MAX_WAIT ]; then
            echo "Error: Database did not become ready in time"
            docker compose -f "$COMPOSE_FILE" logs db
            exit 1
          fi

      - name: Run database migrations
        working-directory: /opt/parseVK
        timeout-minutes: 5
        if: steps.check_migrations.outputs.needs_migrations == 'true'
        run: |
          echo "=== Running database migrations ==="

          if docker compose -f "$COMPOSE_FILE" run --rm --no-deps --entrypoint sh api -c "command -v ./node_modules/.bin/prisma > /dev/null 2>&1 && ./node_modules/.bin/prisma migrate deploy || prisma migrate deploy"; then
            echo "Migrations completed"
          else
            echo "Error: Migrations failed"
            docker compose -f "$COMPOSE_FILE" logs --tail=100 api
            docker compose -f "$COMPOSE_FILE" logs --tail=100 db
            exit 1
          fi

      - name: Build and start containers
        working-directory: /opt/parseVK
        timeout-minutes: 30
        run: |
          echo "=== Building and starting containers ==="

          docker compose -f "$COMPOSE_FILE" build

          if docker compose -f "$COMPOSE_FILE" up -d; then
            echo "Containers started successfully"
          else
            echo "Error: Failed to start containers"
            docker compose -f "$COMPOSE_FILE" logs --tail=50
            exit 1
          fi

          echo "=== Container status ==="
          docker compose -f "$COMPOSE_FILE" ps

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "Commit: $(cd /opt/parseVK && git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
          else
            echo "❌ Deployment failed!"
            echo "Commit: $(cd /opt/parseVK && git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
          fi
